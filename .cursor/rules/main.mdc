---
alwaysApply: true
---

rules

## Runtime and tooling

- **Node.js version**: в этом форке основная версия для разработки — **Node v24**.
  - Зависимости (`npm install`) и webpack-сборка работают на v24 без критических проблем.
  - Upstream Nightscout официально поддерживает `Node 14/16` (см. `package.json: "engines"`), поэтому при необходимости воспроизвести баг для багрепорта в основной репозиторий — использовать `nvm use 16.16.0` (из `.nvmrc`).
  - При апдейте зависимостей или мерже upstream-версии Nightscout могут возникнуть несовместимости с v24 — в таком случае либо фиксим в форке с комментариями в коде, либо воспроизводим на Node 16 для отправки багрепорта.

## Локальная MongoDB (через Docker)

- **Базовый контейнер для разработки**:
  - используем версию, совпадающую с продом: `mongo:7.0.20`;
  - контейнер не должен зависеть от Nightscout-контейнера и может запускаться/останавливаться вручную.

- **Создание и первый запуск** (делается один раз, при необходимости от имени пользователя):

  ```bash
  docker pull mongo:7.0.20

  docker run -d \
    --name ns-mongo-7 \
    -p 27017:27017 \
    -v $HOME/ns-mongo-data-7:/data/db \
    mongo:7.0.20
  ```

  - имя контейнера: `ns-mongo-7`;
  - данные лежат в `~/ns-mongo-data-7` и переживают рестарты контейнера.

- **Ежедневное использование (ручное управление)**:

  - **запустить MongoDB перед запуском Nightscout**:

    ```bash
    docker start ns-mongo-7
    ```

  - **остановить MongoDB, когда не нужна**:

    ```bash
    docker stop ns-mongo-7
    ```

  - **проверить статус**:

    ```bash
    docker ps           # только запущенные
    docker ps -a        # все контейнеры
    ```

  - **посмотреть логи (для отладки)**:

    ```bash
    docker logs -f ns-mongo-7
    ```

- **Подключение Nightscout к локальной Mongo 7.0.20**:

  - Nightscout ожидает строку подключения в одной из переменных окружения (`MONGO_CONNECTION`, `MONGODB_URI`, `MONGO`, и т.п.).
  - Для локальной разработки используем, например:

    ```bash
    export MONGO_CONNECTION="mongodb://localhost:27017/nightscout"
    export API_SECRET="your_long_secret_>=12_chars"
    export PORT=1337
    ```

  - после этого Nightscout можно запускать:

    ```bash
    npm run dev    # или npm start / npm run prod в зависимости от сценария
    ```

## Windows 10 сервер как TLS-прокси для vanzaam.ru

- **Реальность**: у нас **отдельный Windows 10 Pro VPS с белым IP и доменом `vanzaam.ru`**.
  - На этом сервере крутится **nginx + win-acme** для терминации TLS (получение/обновление сертификатов Let's Encrypt).
  - Сам **Nightscout запущен на домашнем Mac** (dev-среда) и **публикуется через FRP-туннель** (frpc на Mac → frps на Windows VPS → nginx).
  - Windows-сервер **НЕ хостит** Nightscout/Mongo напрямую, он только **проксирует HTTPS-трафик**.

- **Архитектура**:
  1. **Mac (localhost:1337)** — Nightscout + MongoDB (Docker).
  2. **Mac (frpc)** — FRP-клиент, туннелирует `localhost:1337` на VPS.
  3. **Windows VPS (frps)** — FRP-сервер, принимает туннель на порт 80.
  4. **Windows VPS (nginx)** — слушает 443 с TLS-сертификатом для `vanzaam.ru`, проксирует на frps:80.
  5. **win-acme** — автоматически обновляет Let's Encrypt сертификат для nginx.

- **Настройка Windows-сервера** (один раз):
  - Установить nginx для Windows.
  - Установить win-acme для автоматического получения/обновления Let's Encrypt сертификата.
  - Настроить nginx:
    - слушать 443 с TLS для `vanzaam.ru`,
    - `proxy_pass` на `http://localhost:80` (где frps отдаёт туннелированный трафик).
  - В файрволе Windows разрешить входящие на 80/443.
  - Запустить frps (конфиг см. в `deploy/frp/README.md` или на VPS).

- **Общее правило**:
  - TLS-терминация **только на Windows VPS** (nginx + win-acme).
  - Nightscout на Mac по HTTP (`localhost:1337`), публикация через **frp-туннель**.
  - **ngrok не используем** — только frp.

## Запуск зависимостей на Mac (Mongo, frpc)

- **Перед тем как предлагать запуск Mongo или frpc в фоне**, сначала **проверить, не запущены ли они уже**:
  - **Mongo:** `docker ps -a --format '{{.Names}} {{.Status}}' | grep ns-mongo-7` — если статус `Up ...`, контейнер уже работает, `docker start ns-mongo-7` не предлагать.
  - **frpc:** `pgrep -fl frpc` — если в выводе есть процесс `frpc -c frpc.toml`, клиент уже в фоне, команду `nohup ./frpc ...` не предлагать.
- **Запуск в фоне предлагать только если проверка показала, что процесс не запущен.**

## Локальный запуск Nightscout + публикация через frpc (vanzaam.ru)

- **Туннель — только frp.** ngrok не используем.
  - На Windows VPS крутится **frps** (порты 7000 для управления, 80 для HTTP-туннеля).
  - На Mac — **frpc** (туннелирует `localhost:1337` на VPS).
  - На Windows VPS **nginx** слушает 443 с TLS-сертификатом (win-acme) для `vanzaam.ru` и проксирует на `localhost:80` (frps).

- **Базовый сценарий (один сайт на `1337`):**

  1. Проверить, что уже запущены Mongo и frpc (см. блок «Запуск зависимостей на Mac»). Если нет — запустить только недостающее (Mongo: `docker start ns-mongo-7`; frpc: `cd deploy/frp && nohup ./frpc -c frpc.toml >> frpc.log 2>&1 &`).
  2. В корне проекта запустить Nightscout:

     ```bash
     npm run dev    # слушает http://localhost:1337 (и при HOSTNAME=0.0.0.0 — http://192.168.50.45:1337)
     ```

  - Доступ: локально **http://192.168.50.45:1337/**; снаружи **https://vanzaam.ru** (VPS → frps:80 → frpc → localhost:1337). Конфиг frpc: `deploy/frp/frpc.toml`, подробности в `deploy/frp/README.md`.

- **Несколько инстансов (порты 1337, 1338, 1339):**

  - Запуск: `PORT=1338 npm run dev` и т.д. В `frpc.toml` можно добавить дополнительные блоки `[[proxies]]` с другими `localPort` и `customDomains` (или субдоменами на VPS).

## Дополнительные замечания

- Если что-то ломается только на новой Node (например, v24), а на `16.16.0` работает, баг считаем «подозрением на несовместимость» и при необходимости:
  - либо фиксим в форке (с комментариями в коде/коммитах, что это Node 20+/24 fix),
  - либо воспроизводим на поддерживаемой Node и отсылаем багрепорт в основной репозиторий Nightscout.

